---
AWSTemplateFormatVersion: '2010-09-09'
Parameters:
   VpcIpv4AddressBlock:
      Description: 'IPv4 address block to assign to the VPC in CIDR format.'
      Type: String
      AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
   EnableIpv6:
      Description: 'Whether to assign an IPv6 address block to the VPC and the subnets.'
      Type: String
      AllowedValues:
         - 'yes'
         - 'no'
      Default: 'yes'
Conditions:
   EnableIpv6: !Equals [ !Ref EnableIpv6 , 'yes' ]
Resources:
   Vpc:
      Type: 'AWS::EC2::VPC'
      Properties:
         CidrBlock: !Ref VpcIpv4AddressBlock
   VpcIpv6AddressBlock:
      Type: 'AWS::EC2::VPCCidrBlock'
      Condition: EnableIpv6
      Properties:
         AmazonProvidedIpv6CidrBlock: true
         VpcId: !Ref Vpc
   #InternetGateway:
   #   Type: 'AWS::EC2::InternetGateway'
   #   Properties:
   AmiBuildSubnet:
      Type: 'AWS::EC2::Subnet'
      Properties:
         CidrBlock: !Select [ 0, !Cidr [ !GetAtt Vpc.CidrBlock, 2, 4 ] ]
         VpcId: !Ref Vpc
   AmiBuildContainerSecurityGroup:
      Type: 'AWS::EC2::SecurityGroup'
      Properties:
         GroupDescription: 'Music AMI build container.'
         VpcId: !Ref Vpc
   AmiBuildInstanceSecurityGroup:
      Type: 'AWS::EC2::SecurityGroup'
      Properties:
         GroupDescription: 'Music AMI build instance.'
         SecurityGroupIngress:
            -
               SourceSecurityGroupId: !GetAtt AmiBuildContainerSecurityGroup.GroupId
               FromPort: 22
               ToPort: 22
               IpProtocol: tcp
         VpcId: !Ref Vpc
   AmiBuildRole:
      Type: 'AWS::IAM::Role'
      Properties:
         AssumeRolePolicyDocument:
            Version: '2012-10-17'
            Statement:
               -
                  Principal:
                     Service: 'codebuild.amazonaws.com'
                  Action: 'sts:AssumeRole'
                  Effect: Allow
         Policies:
            -
               PolicyName: ecr-pull
               PolicyDocument:
                  Version: '2012-10-17'
                  Statement:
                     -
                        Action:
                           - 'ecr:GetDownloadUrlForLayer'
                           - 'ecr:BatchGetImage'
                           - 'ecr:BatchCheckLayerAvailability'
                        Resource: '*'
                        Effect: Allow
            -
               PolicyName: ec2-codebuild
               PolicyDocument:
                  Version: '2012-10-17'
                  Statement:
                     -
                        Action:
                           - 'ec2:DescribeSubnets'
                           - 'ec2:DescribeSecurityGroups'
                        Resource: '*'
                        Effect: Allow
            -
               PolicyName: ec2-ami-create
               PolicyDocument:
                  Version: '2012-10-17'
                  Statement:
                     -
                        Action:
                           - 'ec2:*'
                        Resource: '*'
                        Effect: Allow
   BuildLogsPolicy:
      Type: 'AWS::IAM::Policy'
      Properties:
         PolicyName: logs
         PolicyDocument:
            Version: '2012-10-17'
            Statement:
               -
                  Action:
                     - 'logs:CreateLogGroup'
                     - 'logs:CreateLogStream'
                     - 'logs:PutLogEvents'
                  Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${AmiBuildProject}:*'
                  Effect: Allow
         Roles:
            - !Ref AmiBuildRole
   AmiBuildProject:
      Type: 'AWS::CodeBuild::Project'
      Properties:
         Name: csgo-ami
         Description: 'Build AMI to host Counter Strike: Global Offensive server.'
         ServiceRole: !GetAtt AmiBuildRole.Arn
         Source:
            Type: GITHUB
            Location: 'https://github.com/kalrish/aws-csgo.git'
            GitCloneDepth: 1
            BuildSpec: 'buildspec.yaml'
         Environment:
            Type: LINUX_CONTAINER
            ComputeType: BUILD_GENERAL1_SMALL
            Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/ami-build-env'
            PrivilegedMode: false
            EnvironmentVariables:
               -
                  Name: INSTANCE_SECURITY_GROUP
                  Type: PLAINTEXT
                  Value: !GetAtt AmiBuildInstanceSecurityGroup.GroupId
         VpcConfig:
            VpcId: !Ref Vpc
            Subnets:
               - !Ref AmiBuildSubnet
            SecurityGroupIds:
               - !GetAtt AmiBuildContainerSecurityGroup.GroupId
         Artifacts:
            Type: NO_ARTIFACTS
   RunSubnet:
      Type: 'AWS::EC2::Subnet'
      Properties:
         CidrBlock: !Select [ 1, !Cidr [ !GetAtt Vpc.CidrBlock, 2, 4 ] ]
         VpcId: !Ref Vpc
   RunSecurityGroup:
      Type: 'AWS::EC2::SecurityGroup'
      Properties:
         GroupDescription: 'Music run instances.'
         SecurityGroupIngress:
            -
               CidrIp: '0.0.0.0/0'
               FromPort: 22
               ToPort: 22
               IpProtocol: tcp
         VpcId: !Ref Vpc
