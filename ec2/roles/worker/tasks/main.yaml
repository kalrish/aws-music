---
- name: Update system software
  pacman:
     update_cache: yes
     upgrade: yes
- name: Install required packages
  pacman:
     name: '{{ item }}'
     state: present
  with_items:
     - e2fsprogs
     - f2fs-tools
     - flac
     - git
     - lame
     - opus-tools
     - tup
     - vorbis-tools
     - xfsprogs
- name: Set up git for CodeCommit access
  git_config:
     scope: system
     name: '{{ item.name }}'
     value: '{{ item.value }}'
  loop:
     -
        name: credential.helper
        value: '!aws codecommit credential-helper $@'
     -
        name: credential.UseHttpPath
        value: true
- name: Download build code
  git:
     repo: '{{ code_repo }}'
     dest: '{{ code_dir }}'
     clone: yes
  become_user: music
- name: Enable full dependency tracking for tup
  file:
     path: /usr/bin/tup
     mode: +s
- name: Install pip
  script: get-pip.py
- name: Install AWS CLI
  pip:
     name: awscli
     state: present
- name: Upload systemd service units
  template:
     src: 'music-{{ item }}.service.j2'
     dest: '/etc/systemd/system/music-{{ item }}.service'
     owner: root
     group: root
     mode: u=rw,g=r,o=r
  with_items:
     - build
     - monitor
     - snapshot
     - sync
- name: Enable tup monitor service
  systemd:
     name: music-monitor
     enabled: yes
- name: Create mount points
  file:
     path: '{{ item }}'
     state: directory
     owner: root
     group: root
     mode: 0000
  with_items:
     - '{{ sources_mount_point }}'
     - '{{ builds_mount_point }}'
- name: Create OverlayFS workdir
  file:
     path: '{{ builds_mount_point }}/.overlayfs'
     state: directory
     owner: root
     group: root
     mode: u=rwx,g=rwx,o=rx
- name: Create OverlayFS mount point
  file:
     path: '{{ work_dir }}'
     state: directory
     owner: music
     group: music
     mode: u=rwx,g=rwx,o=rx
- name: Set up work directory
  mount:
     state: mounted
     src: overlay
     fstype: overlay
     opts: 'lowerdir={{ sources_mount_point }}:{{ code_dir }}/tup:{{ profiles_dir }},upperdir={{ builds_mount_point }}/builds,workdir={{ builds_mount_point }}/.overlayfs'
     path: '{{ work_dir }}'

#- name: Mount volumes
#  mount:
#     state: mounted
#     src: '{{ item.src }}'
#     fstype: '{{ item.fstype }}'
#     opts: '{{ item.opts }}'
#     path: '{{ item.path }}'
#  loop:
#     -
#        src: '{{ sources_device_name }}'
#        fstype: '{{ sources_fs_type }}'
#        opts: 'nodev,noexec,nosuid,data=writeback,noatime'
#        path: '{{ sources_mount_point }}'
#     -
#        src: '{{ builds_device_name }}'
#        fstype: '{{ builds_fs_type }}'
#        opts: 'noexec,nosuid,data=writeback,noatime'
#        path: '{{ builds_mount_point }}'
#- name: Initialize tup database
#  command: tup init
#  args:
#     chdir: '{{ work_dir }}'
#  become_user: music
#- name: Upload tup settings for music project
#  copy:
#     src: tup.ini
#     dest: '{{ work_dir }}/.tup/options'
#  become_user: music
