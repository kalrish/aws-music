---
- name: Prepare volume
  hosts: all
  gather_facts: false
  vars:
     dev: /dev/xvdf
     fstype: ext4
  tasks:
     #- name: Upgrade installed packages
     #  yum:
     #     update_cache: yes
     #     upgrade: dist
     #- name: Install required packages
     #  yum:
     #     name: '{{ item }}'
     #  with_items:
     #     - ext4-tools
     #- name: Install pip
     #  script: get-pip.py
     #- name: Install AWS CLI
     #  pip:
     #     name: awscli
     - name: Format EBS volume
       filesystem:
          dev: '{{ dev }}'
          fstype: '{{ fstype }}'
     - name: Mount EBS volume
       mount:
          state: mounted
          src: '{{ dev }}'
          fstype: '{{ fstype }}'
          path: /mnt/music
          boot: no
     #- name: List music sources
     #  aws_s3:
     #     bucket: SOURCE_BUCKET
     #     mode: list
     #  register: music_sources
     #- name: Download music sources
     #  aws_s3:
     #     bucket: SOURCE_BUCKET
     #     mode: get
     #     object: '{{ item }}'
     #     dest: '/mnt/volume/{{ item }}'
     #  with_items: '{{ music_sources.s3_keys }}'
     - name: Download music sources
       command: 'aws s3 cp --quiet --recursive s3://{{ source_bucket }} /mnt/music'
     - name: Unmount EBS volume
       mount:
          state: unmounted
          path: /mnt/music
